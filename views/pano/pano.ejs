<% include ../head.ejs %>
    <title>别人家</title>
    <link rel='stylesheet' href='/stylesheets/pano/pano.css' />
    <script type="text/javascript" src="/javascripts/js/pano/pano.js"></script>
    <script type="text/javascript">
        $.fn.longPress = function(fn) {
            var timeout = undefined;
            var $this = this;
            for(var i = 0;i<$this.length;i++){
                $this[i].addEventListener('touchstart', function(event) {
                    timeout = setTimeout(fn.bind(null, event), 2000);  //长按时间超过800ms，则执行传入的方法
                    }, false);
                $this[i].addEventListener('touchend', function(event) {
                    clearTimeout(timeout);  //长按时间少于800ms，不会执行传入的方法
                    }, false);
            }
        }
    </script>
    <!-- <script type="text/javascript" src="/javascripts/lib/Compass.js"></script> -->

    <!--顶点着色器-->
    <script type="x-shader/x-vertex" id="vshader">
         uniform mat4 projection;
         uniform mat4 modelview;
         attribute vec3 coords;
         varying vec3 vCoords;
         void main() {
            vec4 eyeCoords = modelview * vec4(coords,1.0);
            gl_Position = projection * eyeCoords;
            vCoords = coords;//gl_Position.xyz;
         }
     </script>
    <!--片元着色器-->
    <script type="x-shader/x-fragment" id="fshader">
         precision mediump float;
         varying vec3 vCoords;
         uniform float uSwitchRatio;
         uniform samplerCube uCubeSamplerCur;

         void main() {
                vec4 texColor = textureCube(uCubeSamplerCur, vCoords);
                if(uSwitchRatio == 0.0){
                gl_FragColor = texColor;
                }else{
                gl_FragColor = (vec4(0.12,0.12,0.12,0.16) - texColor)*pow(uSwitchRatio,3.0) + texColor  ;
                }
                //gl_FragColor = vec4(0.5, 0.0, 0.0, 1.0);
         }
     </script>
    <!--相邻全景位置顶点着色器-->
    <script type="x-shader/x-vertex" id="vNeighshader">
         attribute vec4 aCoords;
         uniform mat4 uProjection;
         uniform mat4 uViewMat;
         uniform int uIdSel;
         attribute float aIdCur;
         uniform float uAlpha;
         varying float vAlpha;
         void main() {
            vAlpha = uAlpha;
            gl_Position = uProjection * uViewMat* aCoords;
            //gl_PointSize = 20.0;
         }
     </script>
    <!--相邻全景位置片元着色器-->
    <script type="x-shader/x-fragment" id="fNeighshader">
         precision mediump float;
         varying float vAlpha;
         void main() {
              gl_FragColor = vec4(0.46,0.7,0.7,vAlpha);
         }
     </script>
</head>
<body>
    <div id="all-goods-base" style="position: absolute; top: 0; left: 0"></div>
<div>
    <div class="go-back-area"><i class="iconfont goBack">&#xe61d;</i></div>
</div>
<canvas id="canvas">您的浏览器不支持canvas元素，赶紧更新吧</canvas>
<div id="compass"></div>
<div id="isGoodsShowed">
    <i class="iconfont show-goods">&#xe692;</i>
    <i class="iconfont no-show-goods">&#xe6c1;</i>
</div>
<div id="magnifier">
    <div class="larger"><i class="iconfont">&#xe62b;</i></div>
    <div class="slider">
        <span class="slider-axis"></span>
        <span class="level-line"></span>
    </div>
    <div class="smaller"><i class="iconfont">&#xe62f;</i></div>
</div>
<script type="text/template" id="alertTpl">
    <div class="alert-good-area">
        <div class="alert-good">
            <i class="iconfont close-alert-cross">&#xe617;</i>
            <p>名称： {{=data.name}}</p>
            <p>类型： {{=data.type}}</p>
            <p>品牌： {{=data.brand}}</p>
            <p>链接： <a href="http://taobao.com">www.taobao.com</a></p>
        </div>

    </div>
</script>
<script>
/*       pts : {"a":[{position:[-36.711931,-24.502305,89.732219],path:"resource/5842fa95a5ebde0133fe9bcd/b/",planPt:[40,70]}],
                "b":[{position:[70.566856,-36.871385,-60.504709],path:"resource/5842fa95a5ebde0133fe9bcd/a/",planPt:[63,85]},{position:[26.053868,-65.562604,70.871299],path:"resource/5842fa95a5ebde0133fe9bcd/c/",planPt:[63,50]}],
                "c":[{position:[34.341212,-52.466784,77.89684],path:"resource/5842fa95a5ebde0133fe9bcd/b/",planPt:[40,70]}]
            }*/
    var pts = JSON.parse(JSON.stringify(<%-panos%>));
    var settings = {
        GI:{
            canvas : document.getElementById('canvas'),
            firstPath : "resource/5842f9fba5ebde0133fe9bca/a/",
            smoothSwitch : true,
            pts: {
                a: {
                    neighs: {
                        b: [-36.711931,-24.502305,89.732219]
                    },
                    goods: [{
                        pos: [-13.260473251342773, -17.82830238342285, 97.50031280517578],
                        info: {
                            name: '油汀',
                            type: '电器',
                            brand: '张工牌'
                        }
                    },{
                        pos: [-15.711931,10.502305,89.732219],
                        info: {
                            name: '书架',
                            type: '书架',
                            brand: '宜家'
                        }
                    },{
                        pos: [-76.02099609375, -20.143152236938477, 61.76618576049805],
                        info: {
                            name: '电钢',
                            type: '电器',
                            brand: 'YAMAHA'
                        }
                    },{
                        pos: [-54.82075881958008, -42.49707794189453, 72.03250885009766],
                        info: {
                            name: '面面',
                            type: '设计师',
                            brand: '温柔牌'
                        }
                        
                    }]
                },
                b: {
                    neighs: {
                        a: [70.566856,-36.871385,-60.504709],
                        c: [25.466745376586914, -59.39791488647461, 76.31076049804688]
                    },
                    goods: [{
                        pos: [-40.711931,-25.502305,89.732219],
                        info: {
                            name: '面包机',
                            type: '家电',
                            brand: '松下电子'
                        }
                    }]
                },
                c: {
                    neighs: {
                        b: [34.341212,-52.466784,77.89684]
                    },
                    goods: []
                }                
            }
        }
    };
    var qj = new PanoAJK.Init(settings);

    var argsForCompass = {
        GI : qj.Core,
        dom : document.getElementById('compass'),
        controller : qj.Controller,
        angle : 98,
        path: 'images/pano/'
    };
    var compass = new PanoAJK.Component.Compass(argsForCompass);
    qj.addComponent(compass);
    qj.draw();

    //物品部分
    //标注点闪烁
    // qj.Core.goodPtShine();
    _.templateSettings = {
        evaluate    : /{{([\s\S]+?)}}/g,
        interpolate : /{{=([\s\S]+?)}}/g,
        escape      : /{{-([\s\S]+?)}}/g
    };
    var alertTemplate = _.template($('#alertTpl').html());
    $('#all-goods-base').on('tap', '.good-point', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $('body').append(alertTemplate({data: qj.Core.sys.pts[qj.Core.sys.ptName].goods[parseInt($(this).attr('id'))].info}));
    })
    $('body').on('tap', '.close-alert-cross', function() {
        $('.alert-good-area').remove();
    })

    //长按显示朝向坐标；
    $('body').longPress(function(e){
        var persMat = new PanoAJK.Math.Matrix4().setInverseOf(qj.Core.sys.projection);
        var viewMat = new PanoAJK.Math.Matrix4().setInverseOf(qj.Controller.vmMat4);
        var target = [e.touches[0].clientX, e.touches[0].clientY];
        var canvas = document.getElementById('canvas');
        var cavsBound = canvas.getBoundingClientRect();
        var screenAxis = new PanoAJK.Math.Vector3([(target[0] - cavsBound.left) * 2 / canvas.width - 1, 1 - (target[1] - cavsBound.top) * 2 / canvas.height, 0]);
        var ptt = viewMat.multiply(persMat).multiplyVector4(new PanoAJK.Math.Vector4([screenAxis.elements[0], screenAxis.elements[1], screenAxis.elements[2], 1]));
        var pttt = new PanoAJK.Math.Vector3([ptt.elements[0]/ptt.elements[3], ptt.elements[1]/ptt.elements[3], ptt.elements[2]/ptt.elements[3]]);
        var ptttt = pttt.setLength(100).elements;
        console.log(ptttt);
    });

    /**
    * 缩放时更改旋转速度刷新商品
    * @param {Boolean} bool - true表示放大，false表示缩小
    * @return 
    */
    function scaleProjectionAndSpeedAndGoods(bool) {
        qj.Core.scaleProjectionMat(bool);
        var speed = 32 * (qj.Core.sys.projectionAngle / (120 - qj.Core.sys.projectionAngle));
        qj.Controller.rotatesp =  speed > 32 ? 32 : speed;
        if (qj.Core.sys.showGoods &&  qj.Core.sys.hasGoods) {
                qj.Core.refreshGoodsPos(qj.Controller);
            }
    }
    /**
    * 缩放时按钮闪烁
    * @param {Boolean} bool - true表示放大，false表示缩小
    * @return 
    */
    function scaleAndBlink(bool, ele) {
        scaleProjectionAndSpeedAndGoods(bool);
        $(ele).animate({'background': '#76B3B4', 'color': '#eee'}, 60,function() {
            setTimeout(function() {
                $(ele).css({'background': '#eee', 'color': '#76B3B4'});
            }, 100);
        });
        $('.slider .level-line').css({'top': (qj.Core.sys.projectionAngle-15) *1.1 + '%'});
    }
    $('#magnifier').on('tap', '.larger', function() {
        scaleAndBlink(true, this);
        
    });
    $('#magnifier').on('tap', '.smaller', function() {
        scaleAndBlink(false, this);
    });


    //商品开关
    $('#isGoodsShowed').tap(function() {
        var showJq = $(this).find('.show-goods');
        var noShowJq = $(this).find('.no-show-goods');  
        if (noShowJq.css('display') == 'none') {
            showJq.hide();
            noShowJq.show();
            qj.Core.cutOffGoods();
        } else {
            showJq.show();
            noShowJq.hide();
            qj.Core.cutOnGoods();
        }
        var ele = this;
        $(ele).animate({'background': '#76B3B4', 'color': '#eee'}, 60,function() {
            setTimeout(function() {
                $(ele).css({'background': '#eee', 'color': '#76B3B4'});
            }, 100);
        });
    });    

</script>
</body>
</html>